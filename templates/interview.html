<!-- FULLY FIXED + PREMIUM HR MOCK INTERVIEW PAGE -->
<!-- Round 3 – HR Mock Interview -->
<!-- Paste this entire file in templates/hr_interview.html -->

{% extends "base.html" %}
{% block title %}HR Mock Interview{% endblock %}

{% block head %}
<script>
/* ==========================================================
   ROUND 3 – HR MOCK INTERVIEW (FULLY FIXED & PREMIUM EDITION)
   ========================================================== */

/***************************** CONFIG *****************************/
const ROUND_NAME = "Interview";
const MAX_VIOLATIONS = 5;
let currentQuestionIndex = 0;
let conversation = [];
let finalTranscript = "";
let isRecording = false;
let recognition = null;
let timeout;

const interviewQuestions = [
    "Tell me about yourself.",
    "What are your strengths and weaknesses?",
    "Describe a recent challenge you faced.",
    "Explain one technical concept from your field.",
    "What will you do if you can’t complete a task on time?",
    "Where do you see yourself in 5 years?"
];

/***************************** DOM ELEMENTS *****************************/
let startModal, startBtn, startTestBtn;
let mainContent, submitBtn, statusEl;
let transcriptEl, resultsArea;

/***************************** PROCTORING *****************************/
async function logViolation(type, details = {}) {
    try {
        let r = await fetch("{{ url_for('log_violation') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type, round: ROUND_NAME, details })
        });
        let data = await r.json();
        if (data.flagged) {
            stopRecognition();
            showModal("Disqualified", "You exceeded 5 proctoring violations.");
            setTimeout(() => { window.location.href = "{{ url_for('student_dashboard') }}"; }, 3000);
        }
    } catch (e) { console.error(e); }
}

function setupCamera() {
    let vid = document.getElementById("cameraFeed");
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => vid.srcObject = stream)
        .catch(() => {
            logViolation("CAMERA_DENIED");
            vid.parentElement.innerHTML = `<p class='text-red-600 text-xs'>Camera denied</p>`;
        });
}

document.addEventListener("visibilitychange", () => {
    if (document.hidden) logViolation("TAB_SWITCH");
});
document.addEventListener("contextmenu", e => { e.preventDefault(); logViolation("RIGHT_CLICK"); });
document.addEventListener("keydown", e => {
    if (e.key === "F12" || (e.ctrlKey && e.shiftKey)) {
        e.preventDefault(); logViolation("DEVTOOLS");
    }
});

/***************************** MODALS *****************************/
function showModal(title, msg, color = "text-red-600") {
    const modal = document.getElementById("custom-modal");
    document.getElementById("modal-title").textContent = title;
    document.getElementById("modal-title").className = `text-2xl font-bold mb-4 ${color}`;
    document.getElementById("modal-message").innerHTML = msg;
    modal.style.display = "flex";
}

/***************************** INTERVIEW LOGIC *****************************/
function displayConversation() {
    transcriptEl.innerHTML = conversation.map(line => `
        <div class='${line.speaker === "AI" ? "bg-blue-50 text-blue-700" : "bg-gray-100 text-gray-800"} p-3 rounded-xl mb-2'>
            <b>${line.speaker}:</b> ${line.text}
        </div>`).join("");
    transcriptEl.scrollTop = transcriptEl.scrollHeight;
    finalTranscript = conversation.map(l => `${l.speaker}: ${l.text}`).join("\n");
}

function askNextQuestion() {
    if (currentQuestionIndex >= interviewQuestions.length) return endInterview();

    let q = interviewQuestions[currentQuestionIndex];
    conversation.push({ speaker: "AI", text: q });
    displayConversation();
    speak(q);
    currentQuestionIndex++;
}

function speak(text) {
    let u = new SpeechSynthesisUtterance(text);
    u.rate = 0.9;
    u.onend = () => startRecognition();
    speechSynthesis.speak(u);
}

function setupRecognition() {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;

    recognition.onstart = () => {
        statusEl.textContent = "Listening...";
        statusEl.className = "text-green-600 font-bold";
        isRecording = true;
    };

    recognition.onresult = e => {
        let ans = e.results[0][0].transcript;
        conversation.push({ speaker: "Candidate", text: ans });
        displayConversation();
    };

    recognition.onend = () => {
        isRecording = false;
        statusEl.textContent = "Processing...";
        statusEl.className = "text-yellow-600 font-bold";
        setTimeout(askNextQuestion, 800);
    };
}

function startRecognition() {
    if (!isRecording) {
        try { recognition.start(); } catch {}
    }
}

function startInterview() {
    askNextQuestion();
}

function endInterview() {
    speak("Thank you. The interview is now complete.");
    statusEl.textContent = "Interview Completed";
    statusEl.className = "text-purple-600 font-bold";
    submitBtn.disabled = false;
    submitBtn.classList.remove("opacity-50", "pointer-events-none");
}

async function submitInterview() {
    submitBtn.textContent = "Evaluating...";

    let r = await fetch("{{ url_for('submit_interview') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ transcript: finalTranscript })
    });

    let data = await r.json();
    if (data.success) {
        showModal("Round 3 Completed", "Redirecting to dashboard...", "text-green-600");
        setTimeout(() => window.location.href = "{{ url_for('student_dashboard') }}", 3000);
    }
}

/***************************** PAGE INIT *****************************/
document.addEventListener("DOMContentLoaded", () => {
    startModal = document.getElementById("start-modal");
    startTestBtn = document.getElementById("start-test-btn");
    mainContent = document.getElementById("main-content");
    submitBtn = document.getElementById("submit-btn");
    statusEl = document.getElementById("mic-status");
    transcriptEl = document.getElementById("transcript-text");
    resultsArea = document.getElementById("results-area");

    setupCamera();
    setupRecognition();

    startTestBtn.onclick = () => {
        startModal.style.display = "none";
        mainContent.classList.remove("blur-md", "pointer-events-none");
        startInterview();
    };

    submitBtn.onclick = submitInterview;
});
</script>
{% endblock %}

{% block content %}
<!-- START MODAL -->
<div id="start-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-xl w-96 text-center">
        <h2 class="text-2xl font-bold text-blue-600 mb-3">Start HR Mock Interview</h2>
        <p class="text-gray-600 mb-4">This is a voice-based AI interview. Camera & mic are required.</p>
        <button id="start-test-btn" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">Start Interview</button>
    </div>
</div>

<!-- MAIN CONTENT -->
<div id="main-content" class="max-w-4xl mx-auto blur-md pointer-events-none mt-6 space-y-6">

    <!-- Proctor Panel -->
    <div class="bg-white shadow-lg p-4 rounded-xl flex justify-between items-center sticky top-4 z-30">
        <div class="flex items-center space-x-3">
            <div class="w-16 h-12 bg-gray-200 rounded-lg overflow-hidden border">
                <video id="cameraFeed" autoplay playsinline muted class="w-full h-full object-cover"></video>
            </div>
            <div class="text-red-600 font-bold text-sm">Proctoring Active</div>
        </div>
        <div class="text-lg font-bold">Status: <span id="mic-status" class="text-red-600">Idle</span></div>
    </div>

    <!-- Transcript -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Conversation Transcript</h2>
        <div id="transcript-text" class="h-80 overflow-y-auto bg-gray-50 p-4 rounded-xl text-sm text-gray-800">
            Waiting for interview to start...
        </div>

        <button id="submit-btn" disabled class="mt-6 w-full py-3 bg-red-600 text-white rounded-xl font-bold opacity-50 pointer-events-none">Submit Interview</button>
    </div>
</div>

<!-- Modal -->
<div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-40 items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-xl shadow-xl text-center w-96">
        <h3 id="modal-title" class="text-2xl font-bold text-red-600 mb-3">Alert</h3>
        <p id="modal-message" class="text-gray-700 mb-4"></p>
        <button onclick="document.getElementById('custom-modal').style.display='none'" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold">OK</button>
    </div>
</div>
{% endblock %}